/*********************************************************************
*                Golden-IC Technology Co.,Ltd                        *
*                       www.golden-ic.com                            *
**********************************************************************
*        (c) 2007 - 2014 Golden-IC Technology Co., Ltd               *
*                                                                    *
**********************************************************************
*/
#include <stdlib.h>

#include "GUI.h"
#include "Custom_Widget.h"
#include "GammaFormula.h"

#include "board.h"

/*********************************************************************
*
*       Define
*
**********************************************************************
*/
#define TAN_DEF 14
#define   F1(t)   (1+(t)*(t)*(2*(t)-3))  
#define   F2(t)   ((t)*(t)*(-2*(t)+3))  
#define   F3(t)   ((t)*(1+(t)*((t)-2)))  
#define   F4(t)   ((t)*(t)*((t)-1))

WORD gamma_table_1_2[256]=
{
  0  , 11, 19, 27, 34, 41, 47, 54, 60, 66, 72, 78, 84, 89, 95,100,
  106,111,117,122,127,132,137,143,148,153,158,163,167,172,177,182,
  187,192,196,201,206,210,215,220,224,229,233,238,242,247,251,256,
  260,265,269,273,278,282,287,291,295,300,304,308,312,317,321,325,
  329,334,338,342,346,350,354,359,363,367,371,375,379,383,387,391,
  395,399,403,407,411,415,419,423,427,431,435,439,443,447,451,455,
  459,463,467,471,474,478,482,486,490,494,498,501,505,509,513,517,
  521,524,528,532,536,540,543,547,551,555,558,562,566,570,573,577,
  581,584,588,592,595,599,603,607,610,614,618,621,625,628,632,636,
  639,643,647,650,654,658,661,665,668,672,676,679,683,686,690,693,
  697,701,704,708,711,715,718,722,725,729,732,736,739,743,746,750,
  753,757,760,764,767,771,774,778,781,785,788,792,795,799,802,806,
  809,813,816,819,823,826,830,833,837,840,843,847,850,854,857,860,
  864,867,871,874,877,881,884,888,891,894,898,901,904,908,911,915,
  918,921,925,928,931,935,938,941,945,948,951,955,958,961,965,968,
  971,974,978,981,984,988,991,994,998,1001,1004,1007,1011,1014,1017,1023
};
WORD gamma_table[256]=
{
  0  , 11, 19, 27, 34, 41, 47, 54, 60, 66, 72, 78, 84, 89, 95,100,
  106,111,117,122,127,132,137,143,148,153,158,163,167,172,177,182,
  187,192,196,201,206,210,215,220,224,229,233,238,242,247,251,256,
  260,265,269,273,278,282,287,291,295,300,304,308,312,317,321,325,
  329,334,338,342,346,350,354,359,363,367,371,375,379,383,387,391,
  395,399,403,407,411,415,419,423,427,431,435,439,443,447,451,455,
  459,463,467,471,474,478,482,486,490,494,498,501,505,509,513,517,
  521,524,528,532,536,540,543,547,551,555,558,562,566,570,573,577,
  581,584,588,592,595,599,603,607,610,614,618,621,625,628,632,636,
  639,643,647,650,654,658,661,665,668,672,676,679,683,686,690,693,
  697,701,704,708,711,715,718,722,725,729,732,736,739,743,746,750,
  753,757,760,764,767,771,774,778,781,785,788,792,795,799,802,806,
  809,813,816,819,823,826,830,833,837,840,843,847,850,854,857,860,
  864,867,871,874,877,881,884,888,891,894,898,901,904,908,911,915,
  918,921,925,928,931,935,938,941,945,948,951,955,958,961,965,968,
  971,974,978,981,984,988,991,994,998,1001,1004,1007,1011,1014,1017,1023
};

WORD temp_gamma_table[256];


int Point_X[14] = {0,12,25,38,51,76,102,128,153,179,204,230,243,255};


//---------------------------------------------------------------------------
static void  tangent(double *y, double *dy, int n)
{
    int   i;  
    static double a[TAN_DEF],b[TAN_DEF],c[TAN_DEF],d[TAN_DEF],L[TAN_DEF],U[TAN_DEF],yy[TAN_DEF];


    for(i=1;i<n;i++) a[i]=1;  
    
    b[0]=2;  
    b[n-1]=2;  
    for(i=1;i<n-1;i++) b[i]=4;
    
    for(i=0;i<n-1;i++) c[i]=1;
    
    d[0]=3*(y[1]-y[0]);
    d[n-1]=3*(y[n-1]-y[n-2]);
    for(i=1;i<n-1;i++) d[i]=3*(y[i+1]-y[i-1]);  
       
    U[0]=b[0];
    for(i=1;i<n;i++)
    {  
        L[i]=a[i]/U[i-1];  
        U[i]=b[i]-L[i]*c[i-1];  
    }  

    yy[0]=d[0];  
    for(i=1;i<n;i++) yy[i]=d[i]-L[i]*yy[i-1];  
    
    dy[n-1]=yy[n-1]/U[n-1];  
    for(i=n-2;i>=0;i--) dy[i]=(yy[i]-c[i]*dy[i+1])/U[i];
}

//--------------------------------------------------------------------------
static double spline(double *x, double *y, double *dy, double xa, int n)
{
    int i;
    double   t;
    
    for(i=0;i<n-1;i++) if(xa<=x[i+1]) break;
        
    t=(xa-x[i])/(x[i+1]-x[i]);
    
    return   F1(t)*y[i]+F2(t)*y[i+1]+F3(t)*dy[i]+F4(t)*dy[i+1];
}

//--------------------------------------------------------------------------
/*----256點 gamma數值丟進來算，此公式會依據當有一點Gamma值被調整時，
會去計算其他256點的gamma值該如何調整
*/
static void Cubic_spline_adjustment(WORD *calculate_array)
{
    static double dy[14];
    static double y[14];
    WORD y_axis;
    double  s,xa;
    int i;
    static double    x[14]={0,12,25,38,51,76,102,128,153,179,204,230,243,255};
    
    for(i=0;i<256;i++)
        temp_gamma_table[i]=calculate_array[i];
    
    for(i=0;i<14;i++)
    {
        y[i]= (double) (calculate_array[Point_X[i]]);
    }
    
    
    tangent(y,dy,14);
    for(i=0,xa=0; xa<256; i++,xa++)
    {
        s=spline(x,y,dy,xa,14);
        y_axis = (int)(s+0.5);
        calculate_array[i]=y_axis;
    }
    
    //check if overflow
    for(i=0;i<256;i++)
    {
        if(calculate_array[i]>1023)
        {
            for(i=0;i<256;i++) //TO-CHECK: i is duplicate used in sub-loop.
                calculate_array[i]=temp_gamma_table[i];
            break;
        }
    }
}


int SetGammaPoint(int x, int value)
{
    if( (x > 255) || (x <0) || (value > 1023) || (value < 0) ) return -1;
    
    gamma_table[x] = value;
    Cubic_spline_adjustment(gamma_table);
    
    DEBUGOUT("SetGammaPoint(%d,%d) return %d\r\n", x, value, gamma_table[x]);
    return gamma_table[x];
}


int GetGammaPoint(int x)
{
    if( (x > 255) || (x <0) )  return -1;
    
    return gamma_table[x];
}

const WORD* GetGammaTable(int *TableSize)
{
    if(TableSize)
    {
        *TableSize = sizeof(gamma_table)/sizeof(WORD);
    }
    return gamma_table;
}

int GetGammaPointX_byIndex(int Index)
{
    if( (Index > 13) || (Index <0) )  return -1;
    
    return Point_X[Index];
}

